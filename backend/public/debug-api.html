<!DOCTYPE html>
<html>
<head>
  <title>API Debug (Same-Origin)</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .section { margin: 20px 0; padding: 10px; border: 1px solid #ccc; }
    button { padding: 10px 20px; margin: 5px; }
    pre { background: #f5f5f5; padding: 10px; overflow-x: auto; white-space: pre-wrap; }
    input { width: 100%; max-width: 500px; box-sizing: border-box; padding: 8px; margin: 5px 0; }
    @media (max-width: 640px) {
      body { margin: 12px; }
      button { width: 100%; box-sizing: border-box; }
      input { max-width: 100%; }
    }
  </style>
  <script>
    // Aynı origin üzerinde çalışalım ki CORS/CSP sorunları olmasın
    const API_BASE = `${window.location.origin}/api`;
  </script>
  <script>
    async function safeJson(res) {
      const txt = await res.text();
      try { return JSON.parse(txt); } catch { return txt; }
    }
  </script>
</head>
<body>
  <h1>API Debug (Same-Origin)</h1>

  <div class="section">
    <h3>1. API Sağlık Kontrolü</h3>
    <button onclick="checkHealth()">GET /health</button>
    <pre id="healthResult"></pre>
  </div>

  <div class="section">
    <h3>2. Kullanıcı Giriş Testi</h3>
    <input type="email" id="email" placeholder="Email" value="admin@test.com">
    <input type="password" id="password" placeholder="Password" value="Test123456">
    <button onclick="login()">POST /auth/login</button>
    <pre id="loginResult"></pre>
  </div>

  <div class="section">
    <h3>3. Admin Giriş Testi</h3>
    <input type="text" id="adminUsername" placeholder="Username" value="owner">
    <input type="password" id="adminPassword" placeholder="Password" value="Z3rdeS-9hQm2!7pK">
    <button onclick="adminLogin()">POST /admin/login</button>
    <pre id="adminLoginResult"></pre>
  </div>

  <div class="section">
    <h3>3.1 Admin Token ile Kullanıcı İşlemleri</h3>
    <input type="text" id="adminToken" placeholder="Admin Token" style="width: 500px;">
    <div>
      <button onclick="adminListUsers()">GET /admin/users</button>
    </div>
    <div>
      <input type="text" id="targetUserId" placeholder="User ID">
      <button onclick="adminSendPasswordReset()">POST /admin/users/:userId/password-reset</button>
    </div>
    <pre id="adminUsersResult"></pre>
    <pre id="adminActionResult"></pre>
  </div>

  <div class="section">
    <h3>3.2 Admin: Organizasyon ve Üyeler</h3>
    <div style="margin-bottom:8px;">
      <button onclick="adminListOrganizations()">GET /admin/organizations</button>
    </div>
    <div>
      <input type="text" id="orgId" placeholder="Organization ID" style="width: 500px;">
    </div>
    <div style="margin-top:8px;">
      <button onclick="adminListOrgMembers()">GET /admin/organizations/:orgId/members</button>
      <button onclick="adminListOrgInvites()">GET /admin/organizations/:orgId/invites</button>
    </div>
    <pre id="adminOrgsResult"></pre>
    <pre id="adminOrgMembersResult"></pre>
    <pre id="adminOrgInvitesResult"></pre>
  </div>

  <div class="section">
    <h3>4. Token ile Test</h3>
    <input type="text" id="token" placeholder="JWT Token" style="width: 500px;">
    <button onclick="testToken()">Test Token</button>
    <pre id="tokenResult"></pre>
  </div>

  <div class="section">
    <h3>5. Tenant Test</h3>
    <button onclick="getTenant()">GET /tenants/my-tenant</button>
    <pre id="tenantResult"></pre>
  </div>

  <script>
    async function checkHealth() {
      try {
        const response = await fetch(`${API_BASE}/health`);
        const result = await response.text();
        document.getElementById('healthResult').textContent = `Status: ${response.status}\n${result}`;
      } catch (error) {
        document.getElementById('healthResult').textContent = `Error: ${error.message}`;
      }
    }

    async function login() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      try {
        const response = await fetch(`${API_BASE}/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        const result = await response.json();
        document.getElementById('loginResult').textContent = `Status: ${response.status}\n${JSON.stringify(result, null, 2)}`;
        if (result.access_token) {
          document.getElementById('token').value = result.access_token;
        }
      } catch (error) {
        document.getElementById('loginResult').textContent = `Error: ${error.message}`;
      }
    }

    async function adminLogin() {
      const username = document.getElementById('adminUsername').value;
      const password = document.getElementById('adminPassword').value;
      try {
        const response = await fetch(`${API_BASE}/admin/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });
        const result = await response.json();
        document.getElementById('adminLoginResult').textContent = `Status: ${response.status}\n${JSON.stringify(result, null, 2)}`;
        if (result.adminToken) {
          document.getElementById('adminToken').value = result.adminToken;
        }
      } catch (error) {
        document.getElementById('adminLoginResult').textContent = `Error: ${error.message}`;
      }
    }

    async function adminListUsers() {
      const adminToken = document.getElementById('adminToken').value;
      if (!adminToken) { alert('Lütfen önce admin login yapıp token girin'); return; }
      try {
        const response = await fetch(`${API_BASE}/admin/users`, { headers: { 'admin-token': adminToken } });
        const result = await safeJson(response);
        document.getElementById('adminUsersResult').textContent = `Status: ${response.status}\n${typeof result === 'string' ? result : JSON.stringify(result, null, 2)}`;
      } catch (error) {
        document.getElementById('adminUsersResult').textContent = `Error: ${error.message}`;
      }
    }

    async function adminSendPasswordReset() {
      const adminToken = document.getElementById('adminToken').value;
      const userId = document.getElementById('targetUserId').value;
      if (!adminToken || !userId) { alert('Admin token ve userId gerekli'); return; }
      try {
        const response = await fetch(`${API_BASE}/admin/users/${encodeURIComponent(userId)}/password-reset`, {
          method: 'POST',
          headers: { 'admin-token': adminToken }
        });
        const result = await safeJson(response);
        document.getElementById('adminActionResult').textContent = `Status: ${response.status}\n${typeof result === 'string' ? result : JSON.stringify(result, null, 2)}`;
      } catch (error) {
        document.getElementById('adminActionResult').textContent = `Error: ${error.message}`;
      }
    }

    async function adminListOrganizations() {
      const adminToken = document.getElementById('adminToken').value;
      if (!adminToken) { alert('Lütfen admin token girin'); return; }
      try {
        const response = await fetch(`${API_BASE}/admin/organizations`, { headers: { 'admin-token': adminToken } });
        const result = await response.json();
        document.getElementById('adminOrgsResult').textContent = `Status: ${response.status}\n${JSON.stringify(result, null, 2)}`;
        if (Array.isArray(result) && result.length > 0 && result[0].id) {
          document.getElementById('orgId').value = result[0].id;
        }
      } catch (error) {
        document.getElementById('adminOrgsResult').textContent = `Error: ${error.message}`;
      }
    }

    async function adminListOrgMembers() {
      const adminToken = document.getElementById('adminToken').value;
      const orgId = document.getElementById('orgId').value;
      if (!adminToken || !orgId) { alert('Admin token ve orgId gerekli'); return; }
      try {
        const response = await fetch(`${API_BASE}/admin/organizations/${encodeURIComponent(orgId)}/members`, { headers: { 'admin-token': adminToken } });
        const result = await response.json();
        const summary = Array.isArray(result) ? result.map(x => `${x?.user?.email || '?'} (${x?.role || '?'})`).join('\n') : result;
        document.getElementById('adminOrgMembersResult').textContent = `Status: ${response.status}\n${summary ? summary : JSON.stringify(result, null, 2)}`;
      } catch (error) {
        document.getElementById('adminOrgMembersResult').textContent = `Error: ${error.message}`;
      }
    }

    async function adminListOrgInvites() {
      const adminToken = document.getElementById('adminToken').value;
      const orgId = document.getElementById('orgId').value;
      if (!adminToken || !orgId) { alert('Admin token ve orgId gerekli'); return; }
      try {
        const response = await fetch(`${API_BASE}/admin/organizations/${encodeURIComponent(orgId)}/invites`, { headers: { 'admin-token': adminToken } });
        const result = await response.json();
        const summary = Array.isArray(result) ? result.map(x => `${x?.email || '?'} | acceptedAt=${x?.acceptedAt} | expiresAt=${x?.expiresAt}`).join('\n') : result;
        document.getElementById('adminOrgInvitesResult').textContent = `Status: ${response.status}\n${summary ? summary : JSON.stringify(result, null, 2)}`;
      } catch (error) {
        document.getElementById('adminOrgInvitesResult').textContent = `Error: ${error.message}`;
      }
    }

    async function testToken() {
      const token = document.getElementById('token').value;
      if (!token) { alert('Please enter a token'); return; }
      try {
        const response = await fetch(`${API_BASE}/auth/me`, { headers: { 'Authorization': `Bearer ${token}` } });
        const result = await response.json();
        document.getElementById('tokenResult').textContent = `Status: ${response.status}\n${JSON.stringify(result, null, 2)}`;
      } catch (error) {
        document.getElementById('tokenResult').textContent = `Error: ${error.message}`;
      }
    }

    async function getTenant() {
      const token = document.getElementById('token').value;
      if (!token) { alert('Please enter a token first'); return; }
      try {
        const response = await fetch(`${API_BASE}/tenants/my-tenant`, { headers: { 'Authorization': `Bearer ${token}` } });
        const result = await response.json();
        document.getElementById('tenantResult').textContent = `Status: ${response.status}\n${JSON.stringify(result, null, 2)}`;
      } catch (error) {
        document.getElementById('tenantResult').textContent = `Error: ${error.message}`;
      }
    }
  </script>
</body>
</html>
