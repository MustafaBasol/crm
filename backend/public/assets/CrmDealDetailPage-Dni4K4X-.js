import{u as xe,e as pe,f as ye,v as i,m as e,w as he,x as ge,y as K,z as fe,A as be,B as G,k as H,l as A,F as p,G as je,o as Ne,H as ve,J as we,K as ke,L as De,M as Se}from"./index-CB_hoWrV.js";function Ie(J){const{t:a}=xe("common"),{formatCurrency:h,currency:g}=pe(),{user:f}=ye(),x=J.opportunityId,W=t=>{const s=String(t?.name||"").trim().toLowerCase(),r=s==="lead"?"lead":s==="qualified"?"qualified":s==="proposal"?"proposal":s==="negotiation"?"negotiation":s==="won"?"won":s==="lost"?"lost":null;return r?a(`crm.pipeline.stages.${r}`):t.name},[X,q]=i.useState(!0),[w,o]=i.useState(null),[Z,_]=i.useState([]),[l,U]=i.useState(null),[k,ee]=i.useState([]),[b,B]=i.useState([]),[D,S]=i.useState([]),[j,C]=i.useState([]),[N,I]=i.useState([]),[te,L]=i.useState(!1),[T,P]=i.useState(!1),[M,O]=i.useState(!1),[ae,R]=i.useState(!1),[se,F]=i.useState(!1),z=async()=>{L(!0);try{const[t,s]=await Promise.all([De(x),Se(x)]);C(Array.isArray(t)?t:[]),I(Array.isArray(s)?s:[])}catch(t){A.warn("crm.dealDetail.linkedDocs.loadFailed",t),C([]),I([])}finally{L(!1)}},le=i.useMemo(()=>{if(!l)return[];const t=new Set([...l.ownerUserId?[l.ownerUserId]:[],...(Array.isArray(l.teamUserIds)?l.teamUserIds:[]).filter(Boolean)]),s=(Array.isArray(b)?b:[]).filter(r=>!!r?.user?.id&&t.has(r.user.id)).map(r=>{const c=[r.user.firstName,r.user.lastName].filter(Boolean).join(" ").trim();return{id:r.user.id,label:c||r.user.email||r.user.id}});return s.sort((r,c)=>r.label.localeCompare(c.label)),s},[b,l]),E=i.useMemo(()=>{const t=new Map;for(const s of k)t.set(s.id,s.name);return t},[k]),[d,y]=i.useState(()=>({name:"",accountId:"",amount:"",currency:g,expectedCloseDate:""})),re=async()=>{o(null),q(!0);try{const[t,s,r,c]=await Promise.all([K(x),fe(),be(),G.getAll()]);U(t),_(s??[]),ee(r??[]);try{const n=await H({opportunityId:x}),Q=Array.isArray(n)?n:[];S(Q),z()}catch(n){A.warn("crm.dealDetail.quotes.loadFailed",n),S([]),C([]),I([])}const u=(c??[])[0];if(u?.id){const n=await G.getMembers(u.id);B(n??[])}else B([])}catch(t){A.error("crm.dealDetail.loadFailed",t),o(p(t))}finally{q(!1)}};i.useEffect(()=>{re()},[x]),i.useEffect(()=>{l&&y({name:l.name??"",accountId:l.accountId??"",amount:String(l.amount??""),currency:l.currency??g,expectedCloseDate:l.expectedCloseDate??""})},[l,g]);const v=async()=>{try{const t=await K(x);U(t);try{const s=await H({opportunityId:x}),r=Array.isArray(s)?s:[];S(r),z()}catch{}}catch(t){o(p(t))}},ie=async()=>{if(!l)return;if(!l.accountId){o(a("crm.pipeline.validation.accountRequired"));return}if(!window.confirm(a("crm.dealDetail.createQuoteConfirm",{defaultValue:"Bu anlaşma için taslak teklif oluşturulsun mu?"})))return;const s=new Date,r=m=>m.toISOString().slice(0,10),c=(m,me)=>new Date(m.getTime()+me*864e5),u=l.currency||"TRY",n=Number(l.amount??0)||0,Q=n;try{P(!0);const m=await je({opportunityId:l.id,customerId:l.accountId,issueDate:r(s),validUntil:r(c(s,30)),currency:u,total:n,items:[{description:l.name||a("crm.dealDetail.title"),quantity:1,unitPrice:n,total:Q}],scopeOfWorkHtml:""});if(m?.id)try{window.location.hash=`quotes-edit:${m.id}`;return}catch{}await v()}catch(m){o(p(m))}finally{P(!1)}},[ne,Y]=i.useState(!1),ce=async()=>{if(!l)return;if(!l.accountId){o(a("crm.pipeline.validation.accountRequired"));return}const t=String(window.prompt(a("crm.dealDetail.linkQuotePrompt",{defaultValue:"Bağlamak istediğiniz teklif ID'sini girin (UUID):"}))||"").trim();if(!(!t||!window.confirm(a("crm.dealDetail.linkQuoteConfirm",{defaultValue:"Bu teklif bu anlaşmaya bağlansın mı?"}))))try{Y(!0),await Ne(t,{opportunityId:l.id}),await v()}catch(r){o(p(r))}finally{Y(!1)}},V=()=>{try{window.location.hash="crm-pipeline"}catch{}},oe=async()=>{if(!l)return;o(null);const t=d.name.trim();if(!t){o(a("crm.pipeline.validation.nameRequired"));return}const s=Number(d.amount||0);if(!Number.isFinite(s)||s<0){o(a("crm.pipeline.validation.amountInvalid"));return}if(!d.accountId){o(a("crm.pipeline.validation.accountRequired"));return}try{O(!0),await ve(l.id,{name:t,accountId:d.accountId,amount:s,currency:d.currency,expectedCloseDate:d.expectedCloseDate?d.expectedCloseDate:null}),await v()}catch(r){o(p(r))}finally{O(!1)}},de=async t=>{if(l){o(null);try{R(!0);const s=Array.isArray(l.teamUserIds)?l.teamUserIds:[],c=s.includes(t)?s.filter(n=>n!==t):[...s,t],u=Array.from(new Set([...c??[],...f?.id?[f.id]:[]]));await we(l.id,u),await v()}catch(s){o(p(s))}finally{R(!1)}}},ue=async t=>{if(l&&!(!t||t===l.stageId)){o(null);try{F(!0),await ke(l.id,t),await v()}catch(s){o(p(s))}finally{F(!1)}}},$=i.useMemo(()=>{if(!l)return"";const t=E.get(l.accountId)||"",s=h(Number(l.amount??0),l.currency??"TRY");return[t,s].filter(Boolean).join(" · ")},[E,h,l]);return X?e.jsxs("div",{className:"p-4",children:[e.jsx("h2",{className:"text-lg font-semibold",children:a("crm.dealDetail.title")}),e.jsx("p",{className:"text-sm text-gray-600",children:a("common.loading")})]}):w?e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsx("h2",{className:"text-lg font-semibold",children:a("crm.dealDetail.title")}),e.jsx("button",{type:"button",onClick:V,className:"px-3 py-2 rounded-lg text-sm border border-gray-300 text-gray-700 hover:bg-gray-50",children:a("crm.dealDetail.backToPipeline")})]}),e.jsx("p",{className:"mt-3 text-sm text-red-600",children:w})]}):l?e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"rounded-xl border border-gray-200 bg-white p-6 shadow-sm",children:[e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold text-gray-900",children:l.name}),$&&e.jsx("div",{className:"mt-2 text-sm text-gray-500",children:$})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{type:"button",onClick:V,className:"px-3 py-2 rounded-lg text-sm border border-gray-300 text-gray-700 hover:bg-gray-50",children:a("crm.dealDetail.backToPipeline")}),e.jsx("button",{type:"button",onClick:()=>void ie(),className:"px-3 py-2 rounded-lg text-sm border border-gray-300 text-gray-700 hover:bg-gray-50 disabled:opacity-50",disabled:T,children:T?a("common.loading",{defaultValue:"Yükleniyor..."}):a("crm.dealDetail.createQuote",{defaultValue:"Teklif oluştur"})}),e.jsx("button",{type:"button",onClick:oe,className:"bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg text-sm disabled:opacity-50",disabled:M,children:a(M?"crm.pipeline.saving":"common.save")})]})]}),e.jsxs("div",{className:"mt-6 grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:a("crm.pipeline.fields.opportunityName")}),e.jsx("input",{type:"text",value:d.name,onChange:t=>y(s=>({...s,name:t.target.value})),className:"w-full border rounded-lg px-3 py-2 border-gray-300"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:a("crm.pipeline.fields.account")}),e.jsxs("select",{value:d.accountId,onChange:t=>y(s=>({...s,accountId:t.target.value})),className:"w-full border rounded-lg px-3 py-2 border-gray-300",children:[e.jsx("option",{value:"",children:a("crm.pipeline.selectPlaceholder")}),k.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:a("crm.pipeline.fields.amount")}),e.jsx("input",{type:"number",value:d.amount,onChange:t=>y(s=>({...s,amount:t.target.value})),className:"w-full border rounded-lg px-3 py-2 border-gray-300",min:0,step:"0.01"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:a("crm.pipeline.fields.currency")}),e.jsxs("select",{value:d.currency,onChange:t=>y(s=>({...s,currency:t.target.value})),className:"w-full border rounded-lg px-3 py-2 border-gray-300",children:[e.jsx("option",{value:"TRY",children:"TRY"}),e.jsx("option",{value:"USD",children:"USD"}),e.jsx("option",{value:"EUR",children:"EUR"}),e.jsx("option",{value:"GBP",children:"GBP"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:a("crm.pipeline.fields.expectedCloseDate")}),e.jsx("input",{type:"date",value:d.expectedCloseDate,onChange:t=>y(s=>({...s,expectedCloseDate:t.target.value})),className:"w-full border rounded-lg px-3 py-2 border-gray-300"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:a("crm.pipeline.fields.stage")}),e.jsx("select",{value:l.stageId,onChange:t=>void ue(t.target.value),disabled:se,className:"w-full border rounded-lg px-3 py-2 border-gray-300",children:Z.map(t=>e.jsx("option",{value:t.id,children:W(t)},t.id))})]})]}),e.jsxs("div",{className:"mt-6",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900",children:a("crm.pipeline.fields.team")}),e.jsxs("div",{className:"mt-2 border rounded-lg p-3 max-h-56 overflow-auto",children:[b.length===0&&e.jsx("div",{className:"text-sm text-gray-500",children:a("crm.pipeline.noMembers")}),e.jsx("div",{className:"space-y-2",children:b.map(t=>{const s=t.user.id,r=f?.id&&s===f.id,c=(l.teamUserIds??[]).includes(s)||!!r;return e.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:c,disabled:ae||!!r,onChange:()=>void de(s)}),e.jsxs("span",{className:"text-gray-800",children:[t.user.firstName," ",t.user.lastName," (",t.user.email,")"]})]},t.id)})}),f?.id&&e.jsx("div",{className:"mt-2 text-xs text-gray-500",children:a("crm.pipeline.ownerAutoInTeam")})]})]}),w&&e.jsx("div",{className:"mt-4 text-sm text-red-600",children:w})]}),e.jsxs("div",{className:"rounded-xl border border-gray-200 bg-white p-6 shadow-sm",children:[e.jsx("div",{className:"flex items-center justify-between gap-3",children:e.jsxs("div",{className:"text-sm font-semibold text-gray-900",children:[a("crm.dealDetail.linkedDocs",{defaultValue:"Bağlı satışlar ve faturalar"})," ",e.jsxs("span",{className:"text-xs font-normal text-gray-500",children:["(",j.length+N.length,")"]})]})}),te?e.jsx("div",{className:"mt-3 text-sm text-gray-600",children:a("common.loading",{defaultValue:"Yükleniyor..."})}):j.length===0&&N.length===0?e.jsx("div",{className:"mt-3 text-sm text-gray-600",children:a("crm.dealDetail.noLinkedDocs",{defaultValue:"Bu anlaşmaya bağlı satış veya fatura yok."})}):e.jsxs("div",{className:"mt-3 space-y-6",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"text-sm font-medium text-gray-900",children:[a("sales.title",{defaultValue:"Satışlar"})," ",e.jsxs("span",{className:"text-xs font-normal text-gray-500",children:["(",j.length,")"]})]}),j.length===0?e.jsx("div",{className:"mt-2 text-sm text-gray-600",children:a("crm.dealDetail.noLinkedSales",{defaultValue:"Bağlı satış yok."})}):e.jsx("div",{className:"mt-2 overflow-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left text-gray-500",children:[e.jsx("th",{className:"py-2 pr-4",children:a("sales.table.sale",{defaultValue:"Satış"})}),e.jsx("th",{className:"py-2 pr-4",children:a("sales.table.sourceQuote",{defaultValue:"Kaynak Teklif"})}),e.jsx("th",{className:"py-2 pr-4",children:a("sales.table.status",{defaultValue:"Durum"})}),e.jsx("th",{className:"py-2 pr-4",children:a("sales.table.date",{defaultValue:"Tarih"})}),e.jsx("th",{className:"py-2",children:a("sales.table.amount",{defaultValue:"Tutar"})})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:j.map(t=>{const s=t.saleDate?String(t.saleDate).slice(0,10):t.date?String(t.date).slice(0,10):"",r=Number(t.total??t.amount??0)||0,c=l.currency||g,u=t?.sourceQuoteNumber?String(t.sourceQuoteNumber):"",n=t?.sourceQuoteId?String(t.sourceQuoteId):"";return e.jsxs("tr",{className:"text-gray-800",children:[e.jsx("td",{className:"py-2 pr-4 font-medium",children:e.jsx("button",{type:"button",className:"text-indigo-600 hover:text-indigo-800",onClick:()=>{try{window.location.hash=`sales-edit:${t.id}`}catch{}},title:a("sales.edit",{defaultValue:"Satışı Düzenle"}),children:t.saleNumber||t.id})}),e.jsx("td",{className:"py-2 pr-4",children:n?e.jsx("button",{type:"button",className:"text-indigo-600 hover:text-indigo-800",onClick:()=>{try{window.location.hash=`quotes-edit:${n}`}catch{}},title:a("quotes.editModal.title",{defaultValue:"Teklifi Düzenle"}),children:u||"-"}):e.jsx("span",{children:u||"-"})}),e.jsx("td",{className:"py-2 pr-4",children:String(t.status||"").toUpperCase()}),e.jsx("td",{className:"py-2 pr-4",children:s}),e.jsx("td",{className:"py-2",children:h(r,c)})]},t.id)})})]})})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-sm font-medium text-gray-900",children:[a("invoices.title",{defaultValue:"Faturalar"})," ",e.jsxs("span",{className:"text-xs font-normal text-gray-500",children:["(",N.length,")"]})]}),N.length===0?e.jsx("div",{className:"mt-2 text-sm text-gray-600",children:a("crm.dealDetail.noLinkedInvoices",{defaultValue:"Bağlı fatura yok."})}):e.jsx("div",{className:"mt-2 overflow-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left text-gray-500",children:[e.jsx("th",{className:"py-2 pr-4",children:a("invoices.table.invoice",{defaultValue:"Fatura"})}),e.jsx("th",{className:"py-2 pr-4",children:a("invoices.table.sourceQuote",{defaultValue:"Kaynak Teklif"})}),e.jsx("th",{className:"py-2 pr-4",children:a("invoices.table.status",{defaultValue:"Durum"})}),e.jsx("th",{className:"py-2 pr-4",children:a("invoices.table.date",{defaultValue:"Tarih"})}),e.jsx("th",{className:"py-2",children:a("invoices.table.total",{defaultValue:"Tutar"})})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:N.map(t=>{const s=t.issueDate?String(t.issueDate).slice(0,10):"",r=Number(t.total??0)||0,c=l.currency||g,u=t?.sourceQuoteNumber?String(t.sourceQuoteNumber):"",n=t?.sourceQuoteId?String(t.sourceQuoteId):"";return e.jsxs("tr",{className:"text-gray-800",children:[e.jsx("td",{className:"py-2 pr-4 font-medium",children:e.jsx("button",{type:"button",className:"text-indigo-600 hover:text-indigo-800",onClick:()=>{try{window.location.hash=`invoices-edit:${t.id}`}catch{}},title:a("invoices.edit",{defaultValue:"Faturayı Düzenle"}),children:t.invoiceNumber||t.id})}),e.jsx("td",{className:"py-2 pr-4",children:n?e.jsx("button",{type:"button",className:"text-indigo-600 hover:text-indigo-800",onClick:()=>{try{window.location.hash=`quotes-edit:${n}`}catch{}},title:a("quotes.editModal.title",{defaultValue:"Teklifi Düzenle"}),children:u||"-"}):e.jsx("span",{children:u||"-"})}),e.jsx("td",{className:"py-2 pr-4",children:String(t.status||"").toUpperCase()}),e.jsx("td",{className:"py-2 pr-4",children:s}),e.jsx("td",{className:"py-2",children:h(r,c)})]},t.id)})})]})})]})]})]}),e.jsxs("div",{className:"rounded-xl border border-gray-200 bg-white p-6 shadow-sm",children:[e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"text-sm font-semibold text-gray-900",children:[a("crm.dealDetail.linkedQuotes",{defaultValue:"Bağlı teklifler"})," ",e.jsxs("span",{className:"text-xs font-normal text-gray-500",children:["(",D.length,")"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{type:"button",onClick:()=>void ce(),disabled:ne||T,className:"px-3 py-2 rounded-lg text-sm border border-gray-300 text-gray-700 hover:bg-gray-50 disabled:opacity-60",children:a("crm.dealDetail.linkQuote",{defaultValue:"Teklif bağla"})}),e.jsx("button",{type:"button",onClick:()=>{try{window.location.hash="quotes"}catch{}},className:"px-3 py-2 rounded-lg text-sm border border-gray-300 text-gray-700 hover:bg-gray-50",children:a("quotes.title",{defaultValue:"Teklifler"})})]})]}),D.length===0?e.jsx("div",{className:"mt-3 text-sm text-gray-600",children:a("crm.dealDetail.noLinkedQuotes",{defaultValue:"Bu anlaşmaya bağlı teklif yok."})}):e.jsx("div",{className:"mt-3 overflow-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left text-gray-500",children:[e.jsx("th",{className:"py-2 pr-4",children:a("quotes.table.quote",{defaultValue:"Teklif"})}),e.jsx("th",{className:"py-2 pr-4",children:a("quotes.table.status",{defaultValue:"Durum"})}),e.jsx("th",{className:"py-2 pr-4",children:a("quotes.table.date",{defaultValue:"Tarih"})}),e.jsx("th",{className:"py-2",children:a("quotes.table.amount",{defaultValue:"Tutar"})})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:D.map(t=>{const s=t.issueDate?String(t.issueDate).slice(0,10):"",r=Number(t.total??0)||0,c=t.currency||"TRY";return e.jsxs("tr",{className:"text-gray-800",children:[e.jsx("td",{className:"py-2 pr-4 font-medium",children:e.jsx("button",{type:"button",className:"text-indigo-600 hover:text-indigo-800",onClick:()=>{try{window.location.hash=`quotes-edit:${t.id}`}catch{}},title:a("quotes.editModal.title",{defaultValue:"Teklifi Düzenle"}),children:t.quoteNumber})}),e.jsx("td",{className:"py-2 pr-4",children:String(t.status||"").toUpperCase()}),e.jsx("td",{className:"py-2 pr-4",children:s}),e.jsx("td",{className:"py-2",children:h(r,c)})]},t.id)})})]})})]}),e.jsx(he,{opportunityId:l.id,dealName:l.name}),e.jsx("div",{className:"mt-6",children:e.jsx(ge,{opportunityId:l.id,dealName:l.name,assignees:le})})]}):e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsx("h2",{className:"text-lg font-semibold",children:a("crm.dealDetail.title")}),e.jsx("button",{type:"button",onClick:V,className:"px-3 py-2 rounded-lg text-sm border border-gray-300 text-gray-700 hover:bg-gray-50",children:a("crm.dealDetail.backToPipeline")})]}),e.jsx("p",{className:"mt-3 text-sm text-gray-600",children:a("crm.dealDetail.notFound")})]})}export{Ie as default};
